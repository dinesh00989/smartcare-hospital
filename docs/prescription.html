<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prescription | SmartCare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<nav>
  <h2>üè• SmartCare</h2>
  <div style="display:flex;gap:18px;align-items:center;">
    <a href="index.html">Home</a>
    <a href="appointments.html">Appointments</a>
    <a href="doctors.html">Doctors</a>
    <a href="prescription.html"><b>Prescription</b></a>
    <a href="admin-login.html">Admin</a>
  </div>
</nav>

<!-- DOCTOR LOGIN -->
<section class="section light" id="doctorLoginBox">
  <h3>üîê Doctor Login</h3>
  <input id="docUser" placeholder="Doctor Username (drrao)">
  <input id="docPass" type="password" placeholder="Password">
  <button onclick="doctorLogin()">Login</button>
  <p id="loginError" style="color:red;"></p>
</section>

<!-- PRESCRIPTION MODULE -->
<section class="section" id="prescriptionModule" style="display:none;">
  <div style="display:grid;grid-template-columns:1.1fr 0.9fr;gap:30px;">

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>üíä Create Prescription</h2>
        <button class="btn-danger" onclick="doctorLogout()">Logout</button>
      </div>

      <p style="color:gray;font-size:14px;">
        Logged in as <b id="doctorNameText"></b>
      </p>

      <input id="prePatient" placeholder="Patient Name" oninput="updatePreview()">

      <label style="margin-top:10px;display:block;">Prescription Template</label>
      <select id="prescriptionTemplate" onchange="applyTemplate()">
        <option value="">-- Select Template --</option>
        <option value="fever">Fever / Viral</option>
        <option value="diabetes">Diabetes Follow-up</option>
        <option value="bp">Hypertension (BP)</option>
        <option value="general">General OPD</option>
      </select>

      <textarea id="medicine" placeholder="Medicines & Advice" oninput="updatePreview()"></textarea>

      <button onclick="savePrescription()">Save Prescription</button>
    </div>

    <!-- PREVIEW -->
    <div class="card">
      <h3>üßæ Prescription Preview</h3>
      <p><b>Doctor:</b> <span id="pvDoctor">-</span></p>
      <p><b>Patient:</b> <span id="pvPatient">-</span></p>
      <p><b>Template:</b> <span id="pvTemplate">-</span></p>
      <hr>
      <p id="pvMedicine" style="white-space:pre-line;">-</p>
      <hr>
      <small>Date: <span id="pvDate"></span></small>
    </div>

  </div>
</section>

<script>
const API = "https://smartcare-hospital.onrender.com";

/* ===== Templates ===== */
const templates = {
  fever: "Paracetamol 650mg ‚Äì Twice daily\nCetirizine ‚Äì Night",
  diabetes: "Metformin 500mg ‚Äì Twice daily",
  bp: "Amlodipine 5mg ‚Äì Once daily",
  general: "Multivitamin ‚Äì Once daily"
};

/* ===== Doctor Login (Frontend Only) ===== */
function doctorLogin() {
  const u = docUser.value.trim().toLowerCase();
  const p = docPass.value.trim();

  const doctors = {
    drrao: "Dr. A. Rao",
    drmeena: "Dr. Meena S.",
    drkumar: "Dr. K. Kumar",
    drsharma: "Dr. P. Sharma"
  };

  if (doctors[u] && p === "doctor") {
    localStorage.setItem("doctorName", doctors[u]);
    showModule(doctors[u]);
  } else {
    loginError.textContent = "Invalid credentials";
  }
}

function showModule(name) {
  doctorLoginBox.style.display = "none";
  prescriptionModule.style.display = "block";
  doctorNameText.textContent = name;
  pvDoctor.textContent = name;
  pvDate.textContent = new Date().toLocaleDateString();
}

function doctorLogout() {
  localStorage.removeItem("doctorName");
  location.reload();
}

/* ===== Template Apply ===== */
function applyTemplate() {
  const key = prescriptionTemplate.value;
  if (templates[key]) {
    medicine.value = templates[key];
    pvTemplate.textContent =
      prescriptionTemplate.options[prescriptionTemplate.selectedIndex].text;
    updatePreview();
  }
}

/* ===== Preview ===== */
function updatePreview() {
  pvPatient.textContent = prePatient.value || "-";
  pvMedicine.textContent = medicine.value || "-";
}

/* ===== SAVE (SAME PATTERN AS APPOINTMENTS) ===== */
async function savePrescription() {
  const data = {
    patientName: prePatient.value.trim(),
    doctor: localStorage.getItem("doctorName"),
    diagnosis: pvTemplate.textContent,
    medicines: medicine.value.trim(),
    date: new Date().toLocaleDateString()
  };

  if (!data.patientName || !data.medicines) {
    alert("Fill all fields");
    return;
  }

  try {
    const res = await fetch(`${API}/prescriptions`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (!res.ok) throw new Error();

    alert("‚úÖ Prescription saved");
    prePatient.value = "";
    medicine.value = "";
    updatePreview();

  } catch {
    alert("‚ùå Error saving prescription");
  }
}

/* ===== Auto Restore Login ===== */
const savedDoctor = localStorage.getItem("doctorName");
if (savedDoctor) showModule(savedDoctor);
</script>

</body>
</html>
