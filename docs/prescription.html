<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prescription | SmartCare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<nav>
  <h2>ğŸ¥ SmartCare</h2>
  <div style="display:flex;gap:18px;align-items:center;">
    <a href="index.html">Home</a>
    <a href="appointments.html">Appointments</a>
    <a href="doctors.html">Doctors</a>
    <a href="prescription.html"><b>Prescription</b></a>
    <a href="admin-login.html">Admin</a>
  </div>
</nav>

<!-- DOCTOR LOGIN -->
<section class="section light" id="doctorLoginBox">
  <h3>ğŸ” Doctor Login</h3>
  <input id="docUser" placeholder="Username (ex: drrao)">
  <input id="docPass" type="password" placeholder="Password">
  <button onclick="doctorLogin()">Login</button>
  <p id="loginError" style="color:red;"></p>
</section>

<!-- PRESCRIPTION MODULE -->
<section class="section" id="prescriptionModule" style="display:none;">
  <div style="display:grid;grid-template-columns:1.1fr 0.9fr;gap:30px;">

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>ğŸ’Š Create Prescription</h2>
        <button class="btn-danger" onclick="doctorLogout()">Logout</button>
      </div>

      <p style="color:gray;font-size:14px;">
        Logged in as <b id="doctorNameText"></b>
      </p>

      <input id="prePatient" placeholder="Patient Name" oninput="updatePreview()">

      <label style="margin-top:10px;display:block;">Prescription Template</label>
      <select id="prescriptionTemplate" onchange="applyTemplate()">
        <option value="">-- Select Template --</option>
        <option value="fever">Fever / Viral</option>
        <option value="diabetes">Diabetes Follow-up</option>
        <option value="bp">Hypertension (BP)</option>
        <option value="general">General OPD</option>
      </select>

      <textarea id="medicine" placeholder="Medicines & Advice" oninput="updatePreview()"></textarea>

      <button onclick="savePrescription()">Save Prescription</button>
    </div>

    <div class="card">
      <h3>ğŸ§¾ Prescription Preview</h3>
      <p><b>Doctor:</b> <span id="pvDoctor">-</span></p>
      <p><b>Patient:</b> <span id="pvPatient">-</span></p>
      <p><b>Template:</b> <span id="pvTemplate">-</span></p>
      <hr>
      <p id="pvMedicine" style="white-space:pre-line;">-</p>
      <hr>
      <small>Date: <span id="pvDate"></span></small>
    </div>

  </div>
</section>

<script>
const API = "https://smartcare-hospital.onrender.com";

/* ===== TEMPLATES ===== */
const templates = {
  fever: "Paracetamol 650mg â€“ Twice daily\nCetirizine â€“ Night",
  diabetes: "Metformin 500mg â€“ Twice daily",
  bp: "Amlodipine 5mg â€“ Once daily",
  general: "Multivitamin â€“ Once daily"
};

/* ===== LOGIN ===== */
async function doctorLogin() {
  const username = docUser.value.trim();
  const password = docPass.value.trim();
  loginError.textContent = "";

  try {
    const res = await fetch(`${API}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ username, password })
    });

    if (!res.ok) throw new Error();

    const data = await res.json();
    if (data.role !== "doctor") throw new Error();

    doctorLoginBox.style.display = "none";
    prescriptionModule.style.display = "block";
    doctorNameText.textContent = username;
    pvDoctor.textContent = username;
    pvDate.textContent = new Date().toLocaleDateString();

  } catch {
    loginError.textContent = "Invalid doctor credentials";
  }
}

/* ===== LOGOUT ===== */
function doctorLogout() {
  fetch(`${API}/logout`, { method: "POST", credentials: "include" })
    .then(() => location.reload());
}

/* ===== TEMPLATE ===== */
function applyTemplate() {
  const key = prescriptionTemplate.value;
  if (templates[key]) {
    medicine.value = templates[key];
    pvTemplate.textContent = prescriptionTemplate.options[prescriptionTemplate.selectedIndex].text;
    updatePreview();
  }
}

/* ===== PREVIEW ===== */
function updatePreview() {
  pvPatient.textContent = prePatient.value || "-";
  pvMedicine.textContent = medicine.value || "-";
}

/* ===== SAVE TO BACKEND ===== */
function savePrescription() {
  const data = {
    patientName: prePatient.value,
    doctor: pvDoctor.textContent,
    diagnosis: pvTemplate.textContent,
    medicines: medicine.value,
    date: new Date().toLocaleDateString()
  };

  fetch(`${API}/prescriptions`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(data)
  })
  .then(res => {
    if (!res.ok) throw new Error();
    alert("Prescription saved");
    prePatient.value = "";
    medicine.value = "";
    updatePreview();
  })
  .catch(() => alert("Error saving prescription"));
}
</script>

</body>
</html>
